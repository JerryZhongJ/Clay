# 架构问题与待澄清事项

> 本文档记录了对 `overview.md` 审视后发现的矛盾、缺漏和需要澄清的设计问题。
>
> **创建日期**: 2025-10-18
> **状态**: 待解答

---

## 🔴 关键矛盾与缺漏

### 1. 事件响应的矛盾

**相关文档**: `overview.md:141`

**矛盾描述**:
- 文档第 141 行明确说明:**"原则:事件的响应不产生事件"**
- 但第 131 行说:"System 本身也是模块,它也有功能(如调整 focus 值),也可以注册在自己身上"
- 第 149 行说 Conscious 能产生 `think` 和 `intention` 事件

**待澄清问题**:
1. "事件的响应不产生事件"的具体含义是什么?
2. 如果 System 响应某个事件并调整 focus 值,这个动作本身是否应该产生事件?
3. 如果 Conscious 响应某个事件并产生 `intention`,这是否违反了该原则?
4. 如何追溯某些状态变化的来源?是否需要另一种机制记录因果关系?

**潜在影响**:
- 因果链可能断裂,无法追溯状态变化
- 调试和日志记录困难
- 模块间的交互逻辑不清晰

---

### 2. 注意域容量管理机制未定义

**相关文档**: `overview.md:135-136`

**问题描述**:
文档只说"注意域拥有固定大小。当容量满时,需要清空至特定大小",但缺少关键实现细节。

**待澄清问题**:
1. **容量计量单位**:
   - 按 token 数计算?
   - 按事件数量计算?
   - 按时间跨度计算?
   - 还是混合计算?

2. **清空策略**:
   - 清空到多少容量?(50%? 70%?)
   - 采用什么算法?(FIFO? LRU? 基于重要性?)
   - 如何确定哪些事件可以清空?

3. **触发时机**:
   - 容量达到 100% 时触发?
   - 还是预留缓冲(如 80% 就开始清空)?
   - 清空操作本身是否产生事件?

4. **上下文保护**:
   - 如何保证不丢失关键上下文?
   - 是否有"钉住"(pinned)机制保护重要事件?
   - 连续的事件序列被打断会带来什么问题?

---

### 3. Conscious 与 Memory 的交互逻辑不完整

**相关文档**: `overview.md:68, 256, 61`

**矛盾描述**:
- 第 68 行提到 Memory 提供"即时闪回"
- 第 256 行说"Conscious 能做的,就是多想"
- 第 61 行说"调用其他模块的功能(所有模块都可以互相调用,但 Conscious 应该是最主要的调用者)"

**待澄清问题**:
1. **闪回触发机制**:
   - 闪回是由 Memory 主动触发,还是由 Conscious 请求?
   - 触发的条件是什么?(关键词匹配? 语义相似度?)
   - 触发频率如何控制?

2. **闪回内容准入**:
   - 闪回的内容如何进入注意域?
   - 是否受 Memory 模块的 focus 值限制?
   - 闪回会不会淹没当前正在处理的事件?

3. **主动与被动的边界**:
   - Conscious 能主动调用 Memory 的"提取记忆"功能吗?
   - 如果可以,与"闪回"有什么区别?
   - "Conscious 无法指示应该如何记忆"的具体含义?

---

## 🟡 设计模糊点

### 4. 事件分类系统不完整

**相关文档**: `overview.md:96-100, 125`

**问题描述**:
目前只定义了两种事件标签(`UnderConscious`, `WakeUp`),且第 125 行提到"按重要性排序",但重要性定义不明确。

**待澄清问题**:
1. **事件优先级定义**:
   - 优先级是静态的还是动态的?
   - 由谁决定优先级?(事件生成者? System?)
   - 优先级的量化标准是什么?(1-10? 高中低?)

2. **模块事件的内在优先级**:
   - 不同模块的事件是否有默认优先级差异?
   - 例如,用户输入是否永远高于 Timer 事件?
   - Conscious 的 `intention` 是否高于 `think`?

3. **其他事件类型**:
   - 是否需要 `Urgent`(紧急事件)?
   - 是否需要 `Persistent`(不可清空事件)?
   - 是否需要 `Transient`(短暂事件,快速过期)?

---

### 5. 模块间调用机制的不对称性

**相关文档**: `overview.md:119`

**问题描述**:
> "其他模块向 System append 事件,System 则直接调用这些模块的功能(不是发送事件)"

**待澄清问题**:
1. **设计理由**:
   - 为什么采用不对称设计?(模块→System 用事件,System→模块用直接调用)
   - 这是否违反了"事件流式组织"的统一性?

2. **返回值处理**:
   - 直接调用有返回值吗?
   - 返回值如何处理?会不会转化为事件?
   - 调用失败如何处理?

3. **调用时机**:
   - System 调用其他模块是同步还是异步?
   - 调用过程中 System 是否阻塞?
   - 是否需要超时机制?

---

### 6. 记忆图与结构化存储的整合方案不明确

**相关文档**: `overview.md:231-237`

**问题描述**:
提出了"混合存储方案"(图存储 + 结构化存储),但整合细节不清楚。

**待澄清问题**:
1. **存储决策**:
   - 如何决定某个记忆应该存为图节点还是结构化数据?
   - 是由 Memory 模块自动判断,还是有预设规则?

2. **联想机制**:
   - 结构化数据如何实现"联想"?
   - 通过元数据标签?关键词索引?嵌入向量?

3. **一致性保证**:
   - 两种存储方式的数据如何同步?
   - 更新图节点时,相关的结构化数据如何联动?
   - 删除操作如何处理?

---

## 🟢 架构建议与补充

### 7. 缺少错误处理和状态恢复机制

**问题描述**:
整个文档没有提及错误处理和系统容错设计。

**待补充问题**:
1. **模块崩溃处理**:
   - 如果 LLM API 调用失败,Conscious 模块如何处理?
   - Memory 模块损坏时,系统能否降级运行?
   - 是否需要模块健康检查机制?

2. **状态持久化**:
   - 注意域的状态如何持久化?
   - 事件流是否需要持久化?(类似 Event Sourcing)
   - 持久化的频率和时机?

3. **系统重启恢复**:
   - 系统重启后如何恢复状态?
   - 是否从事件流重放(Event Replay)?
   - 是否需要 checkpoint 机制?

---

### 8. Timer 和 Internet 模块描述过于简略

**相关文档**: `overview.md:76-82`

**待补充问题**:
1. **Timer 模块**:
   - 如何与事件流集成?
   - Timer 事件的优先级?
   - 是否支持周期性事件?(如每分钟报时)

2. **Internet 模块**:
   - 访问网络的触发方式?(被动响应 Conscious 的请求?)
   - 网络请求失败如何处理?
   - 是否有缓存机制?

3. **focus 值设定**:
   - 这两个模块的默认 focus 值应该是多少?
   - 在什么情况下需要调整它们的 focus 值?

---

### 9. 格式设计方案未做决策

**相关文档**: `overview.md:173-191`

**问题描述**:
列举了两个方案(完全结构化 vs 伪结构化),但没有明确选择。

**待决策问题**:
1. **方案选择**:
   - 最终采用哪个方案?还是混合方案?
   - 选择的理由和权衡?

2. **实现影响**:
   - 选择不同方案对 System 模块的实现有何影响?
   - 事件解析器的复杂度差异?
   - Conscious 的 prompt 工程策略?

3. **扩展性考虑**:
   - 未来是否可能切换方案?
   - 是否需要设计格式转换层?

---

## 🔵 SOLID 原则审视

### 开闭原则 (OCP) 风险

**问题描述**:
事件类型目前是硬编码的(第 96-100 行),添加新事件类型可能需要修改 System 核心逻辑。

**建议**:
- 设计事件注册机制,让模块动态注册新事件类型
- 定义事件的元数据结构(如优先级、持久化需求等)

---

### 里氏替换原则 (LSP) 待验证

**待澄清问题**:
- 模块是否可以替换实现?(如用其他方式替换 LLM-based Conscious)
- 模块接口的抽象程度如何?
- 是否需要定义模块的基础接口?

---

### 接口隔离原则 (ISP) 改进空间

**问题描述**:
模块间的接口未明确定义。

**建议**:
- 明确每个模块对外暴露的接口契约
- 区分"功能接口"(供其他模块调用)和"事件接口"(产生的事件类型)
- 定义接口版本管理机制

---

### 依赖倒置原则 (DIP) 风险

**相关文档**: `overview.md:156`

**问题描述**:
Conscious 直接依赖 LLM 实现。

**建议**:
- 定义抽象的 Conscious 接口(如 `ConsciousInterface`)
- 将 LLM-based Conscious 作为具体实现
- 允许未来替换为其他实现(如基于规则的 Conscious)

---

## 📋 优先级建议

### P0 - 必须立即澄清(影响核心架构)

1. ✅ **事件响应的因果链规则** (问题 1)
2. ✅ **注意域的容量管理策略** (问题 2)
3. ✅ **格式设计方案的最终选择** (问题 9)

### P1 - 高优先级(影响模块间集成)

4. ✅ **Conscious 与 Memory 的交互逻辑** (问题 3)
5. ✅ **模块间调用机制的设计理由** (问题 5)
6. ✅ **事件优先级的量化标准** (问题 4)

### P2 - 中优先级(影响健壮性)

7. ✅ **错误处理和状态恢复机制** (问题 7)
8. ✅ **记忆图与结构化存储的整合算法** (问题 6)

### P3 - 低优先级(完善性问题)

9. ✅ **Timer 和 Internet 模块的详细设计** (问题 8)
10. ✅ **SOLID 原则的架构优化** (OCP, LSP, ISP, DIP)

---

## 📝 解答指南

为了高效解答这些问题,建议采用以下格式:

```markdown
### [问题编号] - [问题标题]

**决策**: [你的决定]

**理由**: [为什么这样决定]

**实现要点**:
- 要点 1
- 要点 2

**影响范围**: [这个决策会影响哪些模块/文档]
```

---

**注**:本文档会随着问题的解答逐步更新,已解答的问题将移至 `docs/decisions.md`。
